---
title: Stable Reduced-Bias Estimation of Structural Equation Models using Plugin Penalties
authors:
  - name: Oliver Kemp
    # orcid: 
    email: Oliver.Kemp@warwick.ac.uk
    affiliations:
      - name: University of Warwick
        id: warwick
        department: Department of Statistics
        address: Mathematical Sciences Building, University of Warwick
        city: Coventry
        country: United Kingdom
        postal-code: CV4 7AL
  - name: Ioannis Kosmidis
    email: ioannis.kosmidis@warwick.ac.uk
    orcid: 0000-0003-1556-0302
    affiliations:
      - ref: warwick
  - name: Haziq Jamil
    orcid: 0000-0003-3298-1010
    email: haziq.jamil@ubd.edu.bn
    # corresponding: true
    url: "https://haziqj.ml"
    affiliations:
      - name: Universiti Brunei Darussalam
        id: ubd
        department: Mathematical Sciences, Faculty of Science
        address: Universiti Brunei Darussalam, Jalan Tungku Link
        city: Bandar Seri Begawan
        country: Brunei
        postal-code: BE 1410
      - name: London School of Economics and Political Science
        id: lse
        department: Department of Statistics
        address: Columbia House, Houghton Street
        city: London
        country: United Kingdom
        postal-code: WC2A 2AE
  - name: Yves Rosseel
    orcid: 0000-0002-4129-4477
    email: Yves.Rosseel@UGent.be
    affiliations:
      - name: Ghent University
        id: ugent
        department: Center for Data Analysis and Statistical Science
        address: Krijgslaan 281 - S9
        city: Gent
        country: Belgium
        postal-code: 9000      
date-modified: last-modified
nocite: |
  @*
abstract: |
  {{< lipsum 1 >}}
keywords:
  - Structural Equation Models
  - Growth Curve Models
  - Bias Reduction
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
library(brlavaan)
library(gt)
library(glue)
# library(semPlot)
# library(semptools)
# here::i_am("manuscript/index.qmd")
# load(here::here("experiments/results.RData"))
```

## Introduction

For the iRBM method, we can use an additional plugin penalty to the objective function. 
The plugin penalty acts to shrink the parameter estimates towards some value, thus ensuring that the estimates are finite.
In some cases it might make sense to have penalties shrink to zero, but for others, this is a bit too harsh (e.g. variance parameters or other parameters which are in truth far away from zero).
In these cases, it is more useful to implement a bounded penalty, where such a function acts within a pre-specified parameter range, and penalises the objective function if the parameter estimates stray to the boundaries.
Yet another penalty function that will be explored is a penalty function that shrinks the estimates towards some "ideal" variance-covariance matrix.


Here are the penalty functions:

1. **Ridge penalty (to target $x^*$)**
$$
f(x) = \Vert x - x^* \Vert^2
$$
   Here, $x^*$ could be ideal parameter values, or could be used in conjunction with bounds where $x^*$ is the midpoint of the bounds.

2. **Ridge penalty with bounds $l \leq x \leq u$**
$$
f(x) = \begin{cases}
0 & \text{if } l \leq x \leq u \\
\Vert x - l \Vert^2 & \text{if } x < l \\
\Vert x - u \Vert^2 & \text{if } x > u
\end{cases}
$$

3. **Huber penalty with bounds $l \leq x \leq u$**
$$
f(x) =  \begin{cases} 
\frac{1}{2} y^2 & \text{if } |y| < \tau, \\[10pt]
-\tau \left(\frac{\tau}{2} - |y|\right) & \text{if } |y| \geq \tau,
\end{cases}
$$
where $\tau$ is some threshold (defaults to 1), and 
$$
y =
\begin{cases} 
\log\left(\frac{x - l}{u - x}\right) & \text{if } l,u < \infty \\
\log(x - l) & \text{if } l < \infty, u = \infty \\
0 & \text{if } l,u = \infty
\end{cases}
$$

4. **Matrix norm to target matrix**
   
   To be developed!


### Comparison of penalty functions

```{r}
#| label: fig-penalty-functions
#| fig-cap: 'Comparison of penalty functions.'
lb <- 0
ub <- 3
tibble(
  x = seq(-2, 5, length.out = 250)
) |>
  rowwise() |>
  mutate(
    Ridge = brlavaan:::pen_ridge(x, (lb+ub)/2),
    Ridge_bounded = brlavaan:::pen_ridge_bound(x, lb = lb, ub = ub),
    Huber_bounded = brlavaan:::pen_huber(x, lb = lb, ub = ub),
    Huber_left_bounded = brlavaan:::pen_huber(x, lb = lb, ub = Inf)
  ) |> 
  pivot_longer(-x) |>
  ggplot(aes(x, value, color = name)) +
  annotate("rect", xmin = lb, xmax = ub, ymin = -Inf, ymax = Inf, alpha = 0.2) +
  geom_line() +
  geom_vline(xintercept = c(lb, ub), linetype = "dashed") +
  labs(y = "f(x)") +
  theme_minimal() +
  labs(color = "Penalty") +
  scale_color_discrete(labels = c("Huber bounded", "Huber left bounded", "Ridge", "Ridge bounded"))

```

### Comparing Huber penalty thresholds

```{r}
#| label: fig-huber-comparison
#| fig-cap: 'Comparison of Huber penalty functions with different thresholds.'

lb <- -1
ub <- 4
tibble(
  x = seq(-2, 5, length.out = 250)
) |>
  rowwise() |>
  mutate(
    `0.5` = brlavaan:::pen_huber(x, lb = lb, ub = ub, thres = 0.5),
    `1` = brlavaan:::pen_huber(x, lb = lb, ub = ub, thres = 1),
    `2` = brlavaan:::pen_huber(x, lb = lb, ub = ub, thres = 2)
  ) |> 
  pivot_longer(-x) |>
  ggplot(aes(x, value, color = name)) +
  annotate("rect", xmin = lb, xmax = ub, ymin = -Inf, ymax = Inf, alpha = 0.2) +
  geom_line() +
  geom_vline(xintercept = c(lb, ub), linetype = "dashed") +
  labs(y = "f(x)", col = "Threshold") +
  theme_minimal()
```


```{r}
#| label: fig-huber-comparison-left-bounded
#| fig-cap: 'Comparison of left-bounded Huber penalty functions with different thresholds.'

lb <- -1
ub <- 4
tibble(
  x = seq(-2, 5, length.out = 250)
) |>
  rowwise() |>
  mutate(
    `0.5` = brlavaan:::pen_huber(x, lb = lb, ub = Inf, thres = 0.5),
    `1` = brlavaan:::pen_huber(x, lb = lb, ub = Inf, thres = 1),
    `2` = brlavaan:::pen_huber(x, lb = lb, ub = Inf, thres = 2)
  ) |> 
  pivot_longer(-x) |>
  ggplot(aes(x, value, color = name)) +
  # annotate("rect", xmin = lb, xmax = ub, ymin = -Inf, ymax = Inf, alpha = 0.2) +
  geom_line() +
  geom_vline(xintercept = c(lb), linetype = "dashed") +
  labs(y = "f(x)", col = "Threshold") +
  theme_minimal()
```

<!-- {{< include _intro.qmd >}} -->

<!-- ## Methodology -->

<!-- {{< include _method.qmd >}} -->

<!-- ## Simulation Study -->

<!-- {{< include _simulation.qmd >}} -->

<!-- ## Results -->

<!-- {{< include _results.qmd >}} -->

<!-- ## Discussion -->

<!-- {{< include _discussion.qmd >}} -->

## References {.unnumbered}

::: {#refs}
:::

<!-- ## Appendix {.unnumbered} -->

<!-- {{< include _appendix.qmd >}} -->



