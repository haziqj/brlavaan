---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# brlavaan

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R CMD check](https://github.com/haziqj/sem-bias/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/haziqj/sem-bias/actions/workflows/R-CMD-check.yaml)
[![codecov](https://codecov.io/gh/haziqj/sem-bias/graph/badge.svg?token=00UGXV3BMK)](https://codecov.io/gh/haziqj/sem-bias)
<!-- badges: end -->

Apply empirical bias reduced methods to fit a variety of latent variable models, including confirmatory factor analysis, structural equation modelling, and latent growth curve models.

## Installation

You can install the development version of `{brlavaan}` from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("haziqj/sem-bias")
```

## In brief

`{brlavaan}` provides explicit and implicit bias-reduction maximum likelihood estimation of latent variable models that are `{lavaan}` compatible.
The main functions are

1. `brsem()` for structural equation models.
2. `brcfa()` for confirmatory factor analysis models.
3. `brgrowth()` for growth curve models.
4. `brlavaan()` for a more general interface to fit any model supported by `{lavaan}`.

Note the convention of `br` prefix for all functions in this package. This is to distinguish between the bias-reduced methods and the standard maximum likelihood methods provided by `{lavaan}`.

> [!WARNING]  
> Plugin penalties are not yet supported.

## Example

Here's the beloved classic example -- Bollen (1989)'s political democracy example.

![](https://lavaan.ugent.be/figures/sem.png)


```{r example}
library(brlavaan)
data("PoliticalDemocracy", package = "lavaan")
mod <- "
  # latent variables 
  ind60 =~ x1 + x2 + x3 
  dem60 =~ y1 + y2 + y3 + y4 
  dem65 =~ y5 + y6 + y7 + y8 
   
  # regressions
  dem60 ~ ind60 
  dem65 ~ ind60 + dem60 
  
  # residual covariances 
  y1 ~~ y5
  y2 ~~ y4 + y6 
  y3 ~~ y7 
  y4 ~~ y8
  y6 ~~ y8
"

# lavaan fit (ML)
fit_lav <- sem(model = mod, data = PoliticalDemocracy)

# Bias-reduced fit (by default, implicit method is performed)
fit_iRBM <- brsem(model = mod, data = PoliticalDemocracy) 
summary(fit_iRBM)

# Should be different
tinytest::expect_equal(coef(fit_iRBM), coef(fit_lav))
```

By default, the implicit reduced bias ML estimator is used. 
To switch to the *explicit* RBM, or to add a plugin penalty term, specify these as a list to the `estimator.args` argument.

```{r}
#| eval: false
# for explicit RBM
fit <- brsem(model = mod, data = PoliticalDemocracy, 
             estimator.args = list(rbm = "explicit"))  
# for implicit RBM with plugin penalty
fit <- brsem(model = mod, data = PoliticalDemocracy, 
             estimator.args = list(rbm = "implicit", 
                                   plugin_penalty = brlavaan:::pen_huber))
```

To switch off the bias reduction, set `rbm = "none"`:

```{r}
fit_ML  <- brsem(mod, PoliticalDemocracy, estimator.args = list(rbm = "none"))
tinytest::expect_equal(
   coef(fit_ML),
   coef(fit_lav),
   tolerance = 1e-4
)
```
