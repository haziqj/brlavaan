---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(lavaan)
library(semPlot)
library(semptools)
library(kableExtra)
theme_set(theme_bw())
```

# Empirical bias reducing methods for Structural Equation Models

<!-- badges: start -->
<!-- badges: end -->

Last modified: `r Sys.Date()`

## Toy example: Two factor SEM

Consider the following two factor SEM.

```{r}
n <- 1000
dat <- simulateData(
  model = "
    eta1 =~ 1*y1 + 0.8*y2 + 0.6*y3
    eta2 =~ 1*y4 + 0.8*y5 + 0.6*y6
    eta2 ~ 0.3*eta1
  ",
  sample.nobs = n
)
head(dat)
```

```{r twofacsemsetup}
#| include: false
mod <- "
  eta1 =~ y1 + y2 + y3
  eta2 =~ y4 + y5 + y6
  eta2 ~ eta1
"
fit_lav <- sem(mod, dat)
fit_lav@ParTable$est[-c(1, 4)] <- true_vals <- c(
  0.8, 0.6, 0.8, 0.6,  # lambda
  0.3,  # beta
  rep(1, 6),  # theta_eps
  rep(1, 2)  # psi
)

p <- semPlot::semPaths(
  fit_lav, 
  whatLabels = "est",
  node.width = 1,
  edge.label.cex = 0.75,
  # style = "ram",
  mar = c(-5, -1, 5, -1)
)
```

```{r}
#| label: sempath
#| echo: false
#| message: false

indicator_order <- c(
  "y1", "y2", "y3",
  "y4", "y5", "y6"
)
indicator_factor <- c(
  "eta1", "eta1", "eta1",
  "eta2", "eta2", "eta2"
)
factor_layout <- matrix(c("eta1", "eta2"), byrow = TRUE, nrow = 1)
factor_point_to <- matrix(c("up", "up"), byrow = TRUE, nrow = 1)
p2 <- set_sem_layout(
  p,
  indicator_order = indicator_order,
  indicator_factor = indicator_factor,
  factor_layout = factor_layout,
  factor_point_to = factor_point_to
) |>
  # set_curve(c(
  #   "y1~~y4" = 3,
  #   "y2~~y5" = 3,
  #   "y3~~y6" = 3
  # )) |>
  change_node_label(list(
    list(node = "et1", to = expression(eta[1])),
    list(node = "et2", to = expression(eta[2]))
  ))
plot(p2)
```

Experiment: For each sample size `n` in `c(15, 20, 50, 100, 1000)`, we simulate `B = 1000` datasets and estimate the model parameters in four ways.

1. Maximum likelihood
2. Explicit RBM
3. Implicit RBM
4. Implicit RBM with plugin penalty

Tables and graph below show results (mean bias).

```{r}
#| echo: false
load("R/toysims.RData")
tab
```


```{r}
#| echo: false
p
```

# Growth model a (D&R 2022)

```{r}
#| echo: false
#| fig-height: 7
load("R/DR_sims.RData")
p_growth
```

# Two factor SEM b (D&R 2022)


```{r}
#| echo: false
#| fig-height: 7
p_twofac
```

